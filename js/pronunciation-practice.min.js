class PronunciationPractice{constructor(e){this.container=document.getElementById(e),this.recognition=null,this.synthesis=window.speechSynthesis,this.currentPhrase=null,this.practiceData=[],this.score=0,this.attempts=0,this.isListening=!1,this.selectedLevel="beginner",this.selectedCategory="all",this.initializeSpeechRecognition(),this.loadPracticeData(),this.render(),this.attachEventListeners()}initializeSpeechRecognition(){var e=window.SpeechRecognition||window.webkitSpeechRecognition;e?(this.recognition=new e,this.recognition.lang="ja-JP",this.recognition.continuous=!1,this.recognition.interimResults=!0,this.recognition.maxAlternatives=3,this.recognition.onstart=()=>{this.isListening=!0,this.updateUI()},this.recognition.onend=()=>{this.isListening=!1,this.updateUI()},this.recognition.onresult=e=>{this.handleRecognitionResult(e)},this.recognition.onerror=e=>{this.handleRecognitionError(e)}):this.showError("お使いのブラウザは音声認識に対応していません。ChromeまたはEdgeをご利用ください。")}async loadPracticeData(){try{var e=await(await fetch("/data/pronunciation-practice-data.json")).json();this.practiceData=e.phrases,this.selectRandomPhrase()}catch(e){console.error("練習データの読み込みに失敗しました:",e),this.showError("練習データの読み込みに失敗しました。")}}selectRandomPhrase(){var e,t=this.practiceData.filter(e=>{var t="all"===this.selectedLevel||e.level===this.selectedLevel,e="all"===this.selectedCategory||e.category===this.selectedCategory;return t&&e});0===t.length?this.showError("該当する練習フレーズがありません。"):(e=Math.floor(Math.random()*t.length),this.currentPhrase=t[e],this.updatePhraseDisplay())}updatePhraseDisplay(){var e=this.container.querySelector(".phrase-display");e&&this.currentPhrase&&(e.innerHTML=`
                <div class="phrase-text">${this.currentPhrase.text}</div>
                <div class="phrase-reading">${this.currentPhrase.reading}</div>
                <div class="phrase-context">${this.currentPhrase.context}</div>
                <div class="phrase-level">レベル: ${this.getLevelLabel(this.currentPhrase.level)}</div>
            `)}getLevelLabel(e){return{beginner:"初級",intermediate:"中級",advanced:"上級"}[e]||e}handleRecognitionResult(e){var e=e.results[e.results.length-1],t=e[0].transcript,e=e.isFinal;this.updateTranscriptDisplay(t,e),e&&this.evaluatePronunciation(t)}updateTranscriptDisplay(e,t){var i=this.container.querySelector(".transcript-display");i&&(i.textContent=e,i.classList.toggle("final",t))}evaluatePronunciation(e){var t;this.currentPhrase&&(t=this.currentPhrase.text,t=this.calculateSimilarity(e,t),t=Math.round(100*t),this.attempts++,this.displayResult(t,e),this.updateStats(t),this.provideFeedback(t))}calculateSimilarity(e,t){var i,e=e.replace(/\s/g,"").toLowerCase(),t=t.replace(/\s/g,"").toLowerCase();return e===t||(i=e.length>t.length?e:t,t=e.length>t.length?t:e,0===i.length)?1:(e=this.levenshteinDistance(i,t),(i.length-e)/i.length)}levenshteinDistance(n,a){var r=[];for(let s=0;s<=a.length;s++){let i=s;for(let t=0;t<=n.length;t++)if(0===s)r[t]=t;else if(0<t){let e=r[t-1];n.charAt(t-1)!==a.charAt(s-1)&&(e=Math.min(Math.min(e,i),r[t])+1),r[t-1]=i,i=e}0<s&&(r[n.length]=i)}return r[n.length]}displayResult(e,t){var i=this.container.querySelector(".result-display");i&&(i.innerHTML=`
                <div class="score ${80<=e?"excellent":60<=e?"good":"needs-practice"}">
                    <span class="score-value">${e}%</span>
                    <span class="score-label">${this.getScoreLabel(e)}</span>
                </div>
                <div class="transcript-result">
                    <p>認識された音声: ${t}</p>
                    <p>正解: ${this.currentPhrase.text}</p>
                </div>
            `)}getScoreLabel(e){return 90<=e?"素晴らしい！":80<=e?"とても良い！":70<=e?"良い！":60<=e?"もう少し！":"練習を続けましょう！"}updateStats(e){this.score=Math.round((this.score*(this.attempts-1)+e)/this.attempts);e=this.container.querySelector(".stats-display");e&&(e.innerHTML=`
                <span>平均スコア: ${this.score}%</span>
                <span>練習回数: ${this.attempts}回</span>
            `)}provideFeedback(e){80<=e?this.playSound("success"):this.playSound("try-again"),this.currentPhrase.tips&&e<80&&this.showTips()}showTips(){var e=this.container.querySelector(".tips-display");e&&this.currentPhrase.tips&&(e.innerHTML=`
                <h4>発音のコツ</h4>
                <ul>
                    ${this.currentPhrase.tips.map(e=>`<li>${e}</li>`).join("")}
                </ul>
            `,e.style.display="block")}playModelPronunciation(){var e,t;this.currentPhrase&&this.synthesis&&((e=new SpeechSynthesisUtterance(this.currentPhrase.text)).lang="ja-JP",e.rate=.9,e.pitch=1,e.volume=1,(t=this.synthesis.getVoices().find(e=>e.lang.includes("ja")))&&(e.voice=t),this.synthesis.speak(e))}startListening(){if(this.recognition){if(!this.isListening)try{this.recognition.start(),this.hideTips(),this.clearResult()}catch(e){console.error("音声認識の開始に失敗しました:",e),this.showError("音声認識の開始に失敗しました。")}}else this.showError("音声認識が初期化されていません。")}stopListening(){this.recognition&&this.isListening&&this.recognition.stop()}handleRecognitionError(e){let t="音声認識エラー: ";switch(e.error){case"no-speech":t+="音声が検出されませんでした。";break;case"audio-capture":t+="マイクが見つかりません。";break;case"not-allowed":t+="マイクの使用が許可されていません。";break;default:t+=e.error}this.showError(t)}showError(e){let t=this.container.querySelector(".error-display");t&&(t.textContent=e,t.style.display="block",setTimeout(()=>{t.style.display="none"},5e3))}hideTips(){var e=this.container.querySelector(".tips-display");e&&(e.style.display="none")}clearResult(){var e=this.container.querySelector(".result-display"),e=(e&&(e.innerHTML=""),this.container.querySelector(".transcript-display"));e&&(e.textContent="")}playSound(e){var t=new(window.AudioContext||window.webkitAudioContext),i=t.createOscillator(),s=t.createGain();i.connect(s),s.connect(t.destination),"success"===e?(i.frequency.value=523.25,s.gain.value=.3):(i.frequency.value=261.63,s.gain.value=.2),i.start(),i.stop(t.currentTime+.2)}updateUI(){var e=this.container.querySelector(".record-button");e&&(e.textContent=this.isListening?"停止":"録音開始",e.classList.toggle("listening",this.isListening))}attachEventListeners(){var e=this.container.querySelector(".record-button"),e=(e&&e.addEventListener("click",()=>{this.isListening?this.stopListening():this.startListening()}),this.container.querySelector(".play-model-button")),e=(e&&e.addEventListener("click",()=>this.playModelPronunciation()),this.container.querySelector(".next-phrase-button")),e=(e&&e.addEventListener("click",()=>{this.selectRandomPhrase(),this.clearResult(),this.hideTips()}),this.container.querySelector(".level-select")),e=(e&&e.addEventListener("change",e=>{this.selectedLevel=e.target.value,this.selectRandomPhrase(),this.clearResult(),this.hideTips()}),this.container.querySelector(".category-select"));e&&e.addEventListener("change",e=>{this.selectedCategory=e.target.value,this.selectRandomPhrase(),this.clearResult(),this.hideTips()})}render(){this.container.innerHTML=`
            <div class="pronunciation-practice-container">
                <div class="practice-header">
                    <h3>敬語発音練習</h3>
                    <div class="controls">
                        <select class="level-select">
                            <option value="all">全レベル</option>
                            <option value="beginner" selected>初級</option>
                            <option value="intermediate">中級</option>
                            <option value="advanced">上級</option>
                        </select>
                        <select class="category-select">
                            <option value="all">全カテゴリー</option>
                            <option value="business">ビジネス</option>
                            <option value="daily">日常会話</option>
                            <option value="formal">フォーマル</option>
                        </select>
                    </div>
                </div>

                <div class="phrase-display"></div>

                <div class="practice-controls">
                    <button class="play-model-button">お手本を聞く</button>
                    <button class="record-button">録音開始</button>
                    <button class="next-phrase-button">次のフレーズ</button>
                </div>

                <div class="transcript-display"></div>
                <div class="result-display"></div>
                <div class="tips-display" style="display: none;"></div>
                <div class="error-display" style="display: none;"></div>

                <div class="stats-display">
                    <span>平均スコア: -</span>
                    <span>練習回数: 0回</span>
                </div>
            </div>
        `}}"undefined"!=typeof module&&module.exports?module.exports=PronunciationPractice:window.PronunciationPractice=PronunciationPractice;