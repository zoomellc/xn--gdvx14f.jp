{"version":3,"file":"bundle-loader.js","sourceRoot":"","sources":["../src/bundle-loader.ts"],"names":[],"mappings":"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","sourcesContent":["// Bundle Loader - 動的にJavaScriptバンドルを読み込む\n\n// Bundle configuration types\ninterface BundleConfig {\n  triggers?: string[];\n  scripts: string[];\n  preload?: boolean;\n  autoload?: boolean;\n  condition?: () => boolean;\n  path?: string; // Legacy support\n}\n\ninterface BundleMap {\n  [bundleName: string]: BundleConfig;\n}\n\n// Custom event type for bundle loaded\ninterface BundleLoadedEventDetail {\n  bundleName: string;\n}\n\nclass BundleLoader {\n  private loadedBundles: Set<string>;\n  private bundles: BundleMap;\n  private observer: IntersectionObserver | null = null;\n\n  constructor() {\n    this.loadedBundles = new Set();\n    \n    // バンドル定義\n    this.bundles = {\n      interactive: {\n        triggers: ['honorific-converter', 'honorific-examples', 'honorific-quiz'],\n        scripts: [\n          '/js/min/honorific-converter.min.js',\n          '/js/min/honorific-examples.min.js',\n          '/js/min/honorific-quiz-enhanced.min.js'\n        ],\n        preload: false\n      },\n      utilities: {\n        triggers: ['search-form', 'favorites-button', 'font-size-controls', 'share-buttons', 'popular-posts-widget'],\n        scripts: [\n          '/js/min/search.min.js',\n          '/js/min/favorites.min.js',\n          '/js/min/font-size-adjuster.min.js',\n          '/js/min/share-buttons.min.js',\n          '/js/min/popular-posts.min.js'\n        ],\n        preload: false\n      },\n      mobile: {\n        condition: () => window.innerWidth <= 768,\n        scripts: [\n          '/js/min/mobile-gestures.min.js',\n          '/js/min/mobile-bottom-nav.min.js',\n          '/js/min/mobile-enhancements.min.js'\n        ],\n        preload: true\n      },\n      core: {\n        autoload: true,\n        scripts: [\n          '/js/min/dark-mode.min.js',\n          '/js/min/lazy-load.min.js',\n          '/js/min/table-responsive.min.js'\n        ]\n      },\n      feedback: {\n        triggers: ['feedback-button', 'feedback-system'],\n        scripts: ['/js/min/feedback-system.min.js'],\n        preload: false\n      },\n      dictionary: {\n        triggers: ['honorific-dictionary-container'],\n        scripts: ['/js/min/honorific-dictionary.min.js'],\n        preload: false\n      },\n      comments: {\n        triggers: ['comment-container', 'comment-section'],\n        scripts: ['/js/min/comment-system.min.js'],\n        preload: false\n      },\n      profile: {\n        triggers: ['user-profile-trigger'],\n        scripts: ['/js/min/user-profile.min.js'],\n        preload: false,\n        autoload: true\n      },\n      heatmap: {\n        scripts: ['/js/min/heatmap-tracker.min.js'],\n        preload: false,\n        autoload: true\n      }\n    };\n  }\n\n  // 初期化\n  public init(): void {\n    // 自動読み込みバンドルの読み込み\n    this.loadAutoloadBundles();\n    \n    // Intersection Observerでトリガー要素を監視\n    this.setupObservers();\n    \n    // 条件付きバンドルの確認\n    this.checkConditionalBundles();\n    \n    // プリロード設定\n    this.setupPreloading();\n  }\n\n  // 自動読み込みバンドルの読み込み\n  private loadAutoloadBundles(): void {\n    Object.entries(this.bundles).forEach(([bundleName, config]) => {\n      if (config.autoload) {\n        this.loadBundle(bundleName);\n      }\n    });\n  }\n\n  // Intersection Observerの設定\n  private setupObservers(): void {\n    if (!('IntersectionObserver' in window)) return;\n\n    this.observer = new IntersectionObserver((entries) => {\n      entries.forEach(entry => {\n        if (entry.isIntersecting) {\n          const element = entry.target as HTMLElement;\n          const bundleName = this.findBundleByTrigger(element);\n          \n          if (bundleName && !this.loadedBundles.has(bundleName)) {\n            this.loadBundle(bundleName);\n            this.observer?.unobserve(element);\n          }\n        }\n      });\n    }, {\n      rootMargin: '50px'\n    });\n\n    // トリガー要素を監視\n    Object.entries(this.bundles).forEach(([, config]) => {\n      if (config.triggers) {\n        config.triggers.forEach(trigger => {\n          const elements = document.querySelectorAll<HTMLElement>(\n            `[data-bundle=\"${trigger}\"], .${trigger}, #${trigger}`\n          );\n          elements.forEach(el => this.observer?.observe(el));\n        });\n      }\n    });\n  }\n\n  // トリガー要素からバンドル名を特定\n  private findBundleByTrigger(element: HTMLElement): string | null {\n    for (const [bundleName, config] of Object.entries(this.bundles)) {\n      if (config.triggers) {\n        for (const trigger of config.triggers) {\n          if (element.matches(`[data-bundle=\"${trigger}\"], .${trigger}, #${trigger}`)) {\n            return bundleName;\n          }\n        }\n      }\n    }\n    return null;\n  }\n\n  // 条件付きバンドルの確認\n  private checkConditionalBundles(): void {\n    Object.entries(this.bundles).forEach(([bundleName, config]) => {\n      if (config.condition && config.condition()) {\n        if (config.preload) {\n          this.preloadBundle(bundleName);\n        } else {\n          this.loadBundle(bundleName);\n        }\n      }\n    });\n  }\n\n  // プリロードの設定\n  private setupPreloading(): void {\n    Object.entries(this.bundles).forEach(([bundleName, config]) => {\n      if (config.preload && !config.condition && !config.autoload) {\n        this.preloadBundle(bundleName);\n      }\n    });\n  }\n\n  // バンドルのプリロード\n  private preloadBundle(bundleName: string): void {\n    const config = this.bundles[bundleName];\n    if (!config) return;\n\n    const scripts = config.scripts || (config.path ? [config.path] : []);\n    scripts.forEach(scriptPath => {\n      const link = document.createElement('link');\n      link.rel = 'preload';\n      link.as = 'script';\n      link.href = scriptPath;\n      document.head.appendChild(link);\n    });\n  }\n\n  // バンドルの読み込み\n  public async loadBundle(bundleName: string): Promise<void> {\n    if (this.loadedBundles.has(bundleName)) return;\n\n    const config = this.bundles[bundleName];\n    if (!config) return;\n\n    try {\n      this.loadedBundles.add(bundleName);\n      \n      const scripts = config.scripts || (config.path ? [config.path] : []);\n      let loadedCount = 0;\n      \n      const loadScript = (scriptPath: string): Promise<void> => {\n        return new Promise((resolve, reject) => {\n          const script = document.createElement('script');\n          script.src = scriptPath;\n          script.async = true;\n          \n          script.onload = () => {\n            loadedCount++;\n            if (loadedCount === scripts.length) {\n              const event = new CustomEvent<BundleLoadedEventDetail>('bundleLoaded', {\n                detail: { bundleName }\n              });\n              document.dispatchEvent(event);\n            }\n            resolve();\n          };\n          \n          script.onerror = () => {\n            console.error(`Failed to load script: ${scriptPath}`);\n            reject(new Error(`Failed to load script: ${scriptPath}`));\n          };\n          \n          document.body.appendChild(script);\n        });\n      };\n      \n      // すべてのスクリプトを順番に読み込む\n      for (const scriptPath of scripts) {\n        await loadScript(scriptPath);\n      }\n      \n    } catch (error) {\n      this.loadedBundles.delete(bundleName);\n      console.error(`Error loading bundle ${bundleName}:`, error);\n    }\n  }\n\n  // 手動でバンドルを読み込む\n  public load(bundleName: string): Promise<void> {\n    return this.loadBundle(bundleName);\n  }\n\n  // クリーンアップ\n  public destroy(): void {\n    this.observer?.disconnect();\n    this.observer = null;\n  }\n}\n\n// シングルトンインスタンスを作成\nconst bundleLoaderInstance = new BundleLoader();\n\n// グローバルに公開（互換性のため）\ndeclare global {\n  interface Window {\n    BundleLoader: BundleLoader;\n    bundleLoader: BundleLoader;\n  }\n}\n\nwindow.bundleLoader = bundleLoaderInstance;\nwindow.BundleLoader = bundleLoaderInstance; // 後方互換性\n\n// DOMContentLoadedで初期化\nif (document.readyState === 'loading') {\n  document.addEventListener('DOMContentLoaded', () => bundleLoaderInstance.init());\n} else {\n  bundleLoaderInstance.init();\n}\n\n// ES Module export\nexport default bundleLoaderInstance;\nexport { BundleLoader, type BundleConfig, type BundleMap };"]}