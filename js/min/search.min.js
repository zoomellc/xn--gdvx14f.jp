!function(){"use strict";const e={config:{minSearchLength:2,maxResults:20,highlightClass:"search-highlight",searchDelay:300,cacheExpiry:36e5,storageKey:"searchIndex",popularKey:"popularSearches"},searchIndex:null,searchTimeout:null,searchHistory:[],popularSearches:[],init:function(){this.loadSearchIndex(),this.loadSearchHistory(),this.loadPopularSearches(),this.createSearchForm(),this.setupSearchListeners(),this.setupKeyboardShortcuts()},createSearchForm:function(){const e=document.getElementById("searchWrapper");if(!e||e.querySelector(".search-form"))return;const t=document.createElement("div");t.className="search-form",t.innerHTML='\n        <form role="search" class="relative">\n          <input type="search" \n                 name="q" \n                 placeholder="記事を検索..." \n                 class="search-input w-full px-4 py-3 pr-12 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:bg-white"\n                 autocomplete="off"\n                 aria-label="サイト内検索">\n          <button type="submit" \n                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"\n                  aria-label="検索">\n            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>\n            </svg>\n          </button>\n        </form>\n        <div class="search-suggestions mt-2 hidden"></div>\n        <div class="search-results mt-4"></div>\n      ',e.appendChild(t);const r=t.querySelector("form");r.addEventListener("submit",e=>{e.preventDefault();const t=r.querySelector('input[type="search"]'),a=t.value.trim();a.length>=this.config.minSearchLength&&this.performSearch(a,t)})},loadSearchIndex:async function(){try{const e=this.getCachedIndex();if(e)return void(this.searchIndex=e);const t=await fetch("/index.json");if(!t.ok)throw new Error("Failed to load search index");const r=await t.json();this.searchIndex=this.processIndexData(r),this.setCachedIndex(this.searchIndex)}catch(e){console.error("Error loading search index:",e),this.generateIndexFromDOM()}},getCachedIndex:function(){try{const e=localStorage.getItem(this.config.storageKey);if(!e)return null;const t=JSON.parse(e);return Date.now()-t.timestamp>this.config.cacheExpiry?(localStorage.removeItem(this.config.storageKey),null):t.index}catch(e){return null}},setCachedIndex:function(e){try{const t={index:e,timestamp:Date.now()};localStorage.setItem(this.config.storageKey,JSON.stringify(t))}catch(e){console.warn("Failed to cache search index:",e)}},processIndexData:function(e){return e.map(e=>({title:e.title||"",content:e.content||"",summary:e.summary||"",permalink:e.permalink||"",categories:e.categories||[],tags:e.tags||[],date:e.date||"",searchableText:this.createSearchableText(e)}))},createSearchableText:function(e){return[e.title,e.content,e.summary,(e.categories||[]).join(" "),(e.tags||[]).join(" ")].filter(Boolean).join(" ").toLowerCase()},generateIndexFromDOM:function(){const e=document.querySelectorAll("article, .post, .content");this.searchIndex=Array.from(e).map(e=>{const t=e.querySelector("h1, h2, .title")?.textContent||"",r=e.textContent||"",a=e.querySelector("a")?.href||"";return{title:t.trim(),content:r.trim(),permalink:a,searchableText:(t+" "+r).toLowerCase()}})},loadSearchHistory:function(){try{const e=localStorage.getItem("searchHistory");this.searchHistory=e?JSON.parse(e):[]}catch(e){this.searchHistory=[]}},saveSearchHistory:function(e){if(e&&!(e.length<this.config.minSearchLength)){this.searchHistory=this.searchHistory.filter(t=>t!==e),this.searchHistory.unshift(e),this.searchHistory=this.searchHistory.slice(0,10);try{localStorage.setItem("searchHistory",JSON.stringify(this.searchHistory))}catch(e){console.warn("Failed to save search history:",e)}this.updatePopularSearches(e)}},loadPopularSearches:function(){try{const e=localStorage.getItem(this.config.popularKey);this.popularSearches=e?JSON.parse(e):[]}catch(e){this.popularSearches=[]}},updatePopularSearches:function(e){const t=this.popularSearches.find(t=>t.term===e);t?t.count++:this.popularSearches.push({term:e,count:1}),this.popularSearches.sort((e,t)=>t.count-e.count),this.popularSearches=this.popularSearches.slice(0,10);try{localStorage.setItem(this.config.popularKey,JSON.stringify(this.popularSearches))}catch(e){console.warn("Failed to save popular searches:",e)}},setupSearchListeners:function(){document.querySelectorAll('input[type="search"], input[name="q"], .search-input').forEach(e=>{e.addEventListener("input",e=>{clearTimeout(this.searchTimeout);const t=e.target.value.trim();if(t.length<this.config.minSearchLength)return this.hideSearchResults(),void this.showSearchSuggestions(e.target);this.searchTimeout=setTimeout(()=>{this.performSearch(t,e.target)},this.config.searchDelay)}),e.addEventListener("focus",e=>{e.target.value.trim()||this.showSearchSuggestions(e.target)}),e.addEventListener("blur",e=>{setTimeout(()=>{this.hideSearchResults()},200)}),e.addEventListener("keydown",e=>{if("Enter"===e.key){e.preventDefault();const t=e.target.value.trim();t&&(this.saveSearchHistory(t),this.performFullSearch(t))}})}),document.querySelectorAll(".widget-search__form, .search-form").forEach(e=>{e.addEventListener("submit",t=>{t.preventDefault();const r=e.querySelector('input[type="search"], input[name="q"]');r&&r.value.trim()&&(this.saveSearchHistory(r.value.trim()),this.performFullSearch(r.value.trim()))})})},setupKeyboardShortcuts:function(){document.addEventListener("keydown",e=>{if((e.ctrlKey||e.metaKey)&&"k"===e.key){e.preventDefault();const t=document.querySelector('input[type="search"], input[name="q"]');t&&(t.focus(),t.select())}"Escape"===e.key&&this.hideSearchResults()})},showSearchSuggestions:function(e){const t=this.getOrCreateResultsContainer(e);if(t.innerHTML="",this.popularSearches.length>0){const r=document.createElement("div");r.className="search-suggestions-section",r.innerHTML='<h4 class="text-sm font-semibold text-gray-600 dark:text-gray-400 mb-2">人気の検索キーワード</h4>';const a=document.createElement("ul");a.className="space-y-1",this.popularSearches.slice(0,5).forEach(t=>{const r=document.createElement("li");r.innerHTML=`\n            <button class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors" data-search-term="${t.term}">\n              <span class="text-gray-700 dark:text-gray-300">${t.term}</span>\n              <span class="text-xs text-gray-500 dark:text-gray-500 ml-2">(${t.count}回)</span>\n            </button>\n          `,r.querySelector("button").addEventListener("click",()=>{e.value=t.term,this.performSearch(t.term,e)}),a.appendChild(r)}),r.appendChild(a),t.appendChild(r)}if(this.searchHistory.length>0){const r=document.createElement("div");r.className="search-suggestions-section mt-4",r.innerHTML='<h4 class="text-sm font-semibold text-gray-600 dark:text-gray-400 mb-2">最近の検索</h4>';const a=document.createElement("ul");a.className="space-y-1",this.searchHistory.slice(0,5).forEach(t=>{const r=document.createElement("li");r.innerHTML=`\n            <button class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors flex items-center justify-between" data-search-term="${t}">\n              <span class="text-gray-700 dark:text-gray-300">${t}</span>\n              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>\n              </svg>\n            </button>\n          `,r.querySelector("button").addEventListener("click",()=>{e.value=t,this.performSearch(t,e)}),a.appendChild(r)}),r.appendChild(a),t.appendChild(r)}t.style.display="block"},performSearch:function(e,t){if(!this.searchIndex)return void console.warn("Search index not loaded");const r=this.searchInIndex(e);this.displaySearchResults(r,e,t)},searchInIndex:function(e){const t=e.toLowerCase(),r=t.split(/\s+/).filter(Boolean);return this.searchIndex.map(e=>{let a=0;return e.title.toLowerCase()===t&&(a+=100),e.title.toLowerCase().includes(t)&&(a+=50),r.forEach(t=>{e.title.toLowerCase().includes(t)&&(a+=20),e.searchableText.includes(t)&&(a+=10),e.categories.some(e=>e.toLowerCase().includes(t))&&(a+=15),e.tags.some(e=>e.toLowerCase().includes(t))&&(a+=15)}),{...e,score:a}}).filter(e=>e.score>0).sort((e,t)=>t.score-e.score).slice(0,this.config.maxResults)},displaySearchResults:function(e,t,r){const a=this.getOrCreateResultsContainer(r);if(a.innerHTML="",0===e.length)return a.innerHTML=`\n          <div class="p-4 text-center text-gray-500 dark:text-gray-400">\n            「${t}」に一致する結果が見つかりませんでした\n          </div>\n        `,void(a.style.display="block");const n=document.createElement("div");n.className="p-3 border-b border-gray-200 dark:border-gray-700",n.innerHTML=`\n        <span class="text-sm text-gray-600 dark:text-gray-400">\n          ${e.length}件の結果が見つかりました\n        </span>\n      `,a.appendChild(n);const s=document.createElement("ul");s.className="divide-y divide-gray-200 dark:divide-gray-700",e.forEach(e=>{const r=document.createElement("li");r.className="hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors";const a=this.highlightText(e.title,t),n=this.createSnippet(e.content||e.summary,t);r.innerHTML=`\n          <a href="${e.permalink}" class="block p-3">\n            <h4 class="font-medium text-gray-900 dark:text-gray-100 mb-1">\n              ${a}\n            </h4>\n            ${n?`<p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">${n}</p>`:""}\n            ${e.categories.length>0?`\n              <div class="mt-1 flex flex-wrap gap-1">\n                ${e.categories.map(e=>`\n                  <span class="text-xs px-2 py-0.5 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded">\n                    ${e}\n                  </span>\n                `).join("")}\n              </div>\n            `:""}\n          </a>\n        `,s.appendChild(r)}),a.appendChild(s),a.style.display="block"},highlightText:function(e,t){if(!e||!t)return e;const r=new RegExp(`(${t.split(/\s+/).join("|")})`,"gi");return e.replace(r,'<mark class="bg-yellow-200 dark:bg-yellow-800">$1</mark>')},createSnippet:function(e,t){if(!e||!t)return"";const r=t.toLowerCase(),a=e.toLowerCase(),n=a.indexOf(r);if(-1===n){const r=t.split(/\s+/)[0].toLowerCase(),n=a.indexOf(r);if(-1!==n){const r=Math.max(0,n-50),a=Math.min(e.length,n+100);return"..."+this.highlightText(e.substring(r,a),t)+"..."}return e.substring(0,150)+"..."}const s=Math.max(0,n-50),o=Math.min(e.length,n+100),i=e.substring(s,o);return(s>0?"...":"")+this.highlightText(i,t)+(o<e.length?"...":"")},getOrCreateResultsContainer:function(e){let t=e.parentElement.querySelector(".search-results-container");return t||(t=document.createElement("div"),t.className="search-results-container absolute z-50 w-full mt-1 bg-white dark:bg-gray-900 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 max-h-96 overflow-y-auto",t.style.display="none",e.parentElement.style.position="relative",e.parentElement.appendChild(t)),t},hideSearchResults:function(){document.querySelectorAll(".search-results-container").forEach(e=>{e.style.display="none"})},performFullSearch:function(e){window.location.href=`/search?q=${encodeURIComponent(e)}`},refreshIndex:async function(){localStorage.removeItem(this.config.storageKey),await this.loadSearchIndex()}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{e.init()}):e.init(),window.Search=e,window.SiteSearch=e}();